

## なぜバッチを書くのか？

サーバーだったら、

1. 本番サーバーのバックアップを取りたい

1ヶ月分のバックアップをどこかに移動させるとか。
本番サーバーの最新の内容を毎朝06:00に自動で適用するとか、開発サーバーに
昔は容量圧迫するから3ヶ月分や半年前までは保存して、
特定の日に消すというところが多かったけど、
最近はとりあえず残しとこう。というところが多い。

これも本番から開発にデータ移すときは
プライバシーの問題で
メールアドレスを全て会社のdeveloper@co.jp
メール送信のテスト用アカウントにする。
みたいなアカウントにして
パスワードを全てパスワードに上書きするとか。

これをバッチ処理でやっておくと、間違って
お客さんにメール飛ばないから安心間がある。


名前もID+テスト太郎にupdateしておくと、
誰のデータかわからんようになるから
これやっとくとオペミス減って楽。


2. メールの自動送信

決済日に送信
これやらないとお客さんがよくわからないけど
決済されてる、詐欺じゃ無い？!となるので必須。
実際何でもないのでクレジットカード会社に
へんな決済されていると連絡してそれでキャンセルされたから、
もう一度決済してもらうことになった事例を前経験しました。

クレジットカードの支払いキャンセルされたかどうかは、
決済代行システムを使ってる場合はそっちで支払いキャンセルされたかどうか
確認するしかないから、事務作業になる。
stripeとかだとクレジットカードキャンセルされたとかで、
なんらかのリクエスト送ってくれたりするのかな？
もし知ってる人いたら後で教えて欲しいです。



クレジットカードの会社とかは決済日の何日前とかに
送ったりと、決済日の両方送ったりする。

新聞とかそれ系のWebアプリで多い。
定期的に読ませたい新しい記事を読ませたいから
サブスクリプション契約してやったーじゃなくて、
じゃなくて、サブスクリプションって継続させることに意味があるので、
契約したから、こういう記事が読めるというメリットありますよ。
ということで新しい記事の要約を送ったり。
これは無料会員に対しても送ること多い。

これもrailsやlaravel側のメール送信用のライブラリ使ったらいいのでは無いか？
という人も結構いると思うんですが、
それをやるとバッチ処理がwebアプリケーションに決め打ちされてしまうのと、
コントローラーのいろんな部分でメール送信の実装が出てくるので、管理がしんどくなる。
あと何らかの設定ミスだったりバグでメールが送れなかった場合、
結局バッチから送るということになると思うので
2度手間じゃ無いかと。


メールの文書って結局開発側で決めれなくて、経営陣やそれにつぐ人に聞かないとダメな
ことが多いし、場合によってはどんなメールが送信されるのか管理しときたいということがあって、
それだとコントローラーのいろんな部分にメール送信の実装が出てくる作りだと厳しい。

メール送信の実装をバッチ側に隠蔽して、
そこからDBを見て送信見たいにすると良い。
バッチ側にメール送信の実装を移しておいて、
Webアプリからバッチ処理(api)叩くようにしておいて、

そういう使い方するなら、
オンプレならイベント
クラウドならキューに入れてという使い方になるのかな？

ここらへんはPMとよく相談してから決めたらいいと思います。


データ量が多くなったら、
お名前.comが

3. 外部システムとの連携
15分おきにどこかのシステムのデータ見に行かないといけないとか。


これは最近増えた要件だと思うんですが、

3. 社内SNSに投稿

slackに決済データや予定の人を投稿
経営者と経理の人間だけ見れるチャンネルを作って
決済日に何人決済された？
金額合ってる？
特に新しい機能を追加したときは必ず必要な作業になります。

異常系だった場合アラートとして送信。
さっき描いた15分分おきにシステムのデータ見に行くとかもそう描いてたら、
15分おきにslackに投稿するようにしていて、
ちゃんとデータ連携していなかったら、メンションつけてERRORみたいな
メッセージでるからエンジニア読んでと
しといたら、
運用側もスムーズ。

それ以外にも色々あるんですが、
定期的に聞かれること、共有が決まってるやつは全部、
アプリ作ってチャンネル見といてで済みます。

これやらないと定期的にエンジニアの

ベンチャーのエンジニア字面だけ見るとキラキライメージだけどたぶん過労死する
その実一人で開発と運用とヘルプデスクやってるところザラですし。

実を言うとヘルプデスク的な仕事は大体、
slackのアプリにして事務と連携したら解決できるんですよ。

大手Sierが作ったプロジェクトでこれ売り込めたらいいな
って思ってたんですが、これ売り込みたかったらSier飛ばしてエンドに売り込まないといけないから売り込むの難しいと
わかって放置してる。

ヘルプデスク的な仕事は実はほとんど無くせる
というのが現実。

クライアント側

1. 設定を切り替えたい。

例えば、gcpやawsの設定を環境変数で
.bash_profileで見ていて、案件事や開発環境のDB

2. 便利ツール作る。

自分がよくやってる行動からこう言うのあったら楽だなとか。
.envファイルをbash上で読み込んで環境変数にする物が
無いから欲しいと思って自分は設定したり、

いちいちブラウザ立ち上げてdeepl翻訳使うの面倒だから、

3. ローカルから開発用と本番用のコマンド作って

使い分けるとか。

本番のデータ見に行かないとダメなこと普通にあるので。
